---
title: 管理本地用户和组（一）
lang: zh-CN
tags: 
  - Linux
  - RHEL
  - RHCE
  - 认证考试
categories: 
  - [学习, Linux]
  - [日常记录]
  - [迁移文章]
---
> 🔴 此文章由之前的 Typora 笔记迁移过来，内容可能已经过时。

## 用户和组的概念

### 什么是用户

用户账户用于在可以运行命令的不同人员和程序之间提供安全界限。

​用户使用用户名向人类用户标识自己并增加操作的便利性。在内部，系统通过分配的唯一标识号用户ID或UID）来区分不同的用户帐户。人类使用用户帐户时，通常会为其分配一个密码，供用户用于在登录时证明他们是实际的授权用户。

用户帐户构成了系统安全的基础。系统中的每个进程（运行程序）都作为一个特定用户运行。每个文件都有一个特定用户作为其所有者。文件所有权有助于系统对文件用户实施访问控制。与运行进程相关联的用户可确定该进程可访问的文件和目录。

​用户帐户有三种主要类型：超级用户、系统用户和普通用户。

* 超级用户帐户用于管理系统。超级用户的名称为 root，其帐户 UID 为 0。超级用户对系统具有完全访问权限。

* 系统用户帐户供提供支持服务进程使用。这些进程（或守护进程）通常不需要以超级用户身份运行。系统会为它们分配非特权帐户，允许它们确保其文件和其他资源不受彼此以及系统上普通用户的影响。用户无法使用系统用户帐户以交互方式登录。

* 普通用户是大多数用户都有用于处理日常工作的帐户。与系统用户一样，普通用户对系统具有有限的访问权限。。

​可以使用 `id` 命令显示有关当前已登陆用户的信息。

```bash
id [OPTION]... [USER] # 打印真实有效的用户和其组 ID，忽略 USER 时打印当前用户的用户和其组信息
# 常见选项（下面四个只能四选一）：
-g, --group # 只打印有效的组 ID
-G, --groups # 打印所有的组 ID
-u, --user # 只打印有效的用户 ID
-Z, --context # 只打印进程安全上下文
## 用于 -g、-G、-u 之后的：
-n, --name # 打印名字而不是用户 ID
-r, --real # 打印真实 ID 而不是有效 ID
```

```bash
[root@localhost ~]\# id
uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023	# 安全上下文
[root@localhost ~]\# id -ur student
1000	# 只打印 student 用户的用户ID
```

​存储用户信息的配置文件为 /etc/passwd 文件，它的格式为：

​		​`用户名`:`加密的用户密码`[^1]:`用户UID`:`用户主要组的GID`:`用户真实姓名`:`用户主目录`:`用户的默认登陆shell`[^2]

[^1]: 已弃用，现在该字段始终应为 `x`，密码配置已经移到了 /etc/shadow 配置文件。
[^2]: 对于普通用户一般来说是 /bin/bash，某些服务的系统用户一般不允许进行交互式登陆，其可能会使用：/sbin/nologin。

​例子：

```bash
[root@localhost ~]\# head -n 1 /etc/passwd
root:x:0:0:root:/root:/bin/bash
```

#### 红帽 UID 范围划分

| UID 范围 | 账户范围                                                     |
| :------: | ------------------------------------------------------------ |
|    0     | root                                                         |
|  1-200   | 系统用户，红帽静态分配给一些系统进程                         |
| 201-999  | 系统用户，供文件系统中没有自己的文件的系统进程使用。一般是一些后续安装的系统服务，由红帽动态分配，用来限制这些服务仅访问它们正常运行所需的资源。 |
|  1000+   | 普通用户                                                     |

### 什么是组

​组是需要共享文件和其他系统资源访问权限的用户的集合。组可用于向一组用户授予文件访问权限，而非仅仅向一个用户授予访问权限。

​与用户相似，组也有组名称以增加操作的便利性。在內部，系统通过分配的唯一标识号（组ID或GID）来区分不同的组。

​存储用户组信息的配置文件为 /etc/group 文件，它的格式为：

​		`组名称`:`组密码`[^3]:`该组的GID号`:`组成员列表（以逗号作为分界符）`

[^3]: 已弃用，该字段始终应为 `x`。组密码配置文件已移至 /etc/gshadow。

#### 主要组和补充组

​每个用户有且只有一个主要组。对于本地用户而言，这是按 /etc/passwd 文件中的 GID 号列出的组。默认情况下，这是拥有用户创建的新文件的组。

​通常，在创建新的普通用户时，会创建一个与该用户同名的新组。该组将用作新用户的主要组，而该用户是这一用户专用组的唯一成员。事实证明，这有助于简化文件权限的管理。

​用户也可以有补充组。补充组的成员资格由 /etc/group 文件确定。根据所在的组是否具有访问权限，将授予用户对文件的访问权限。具有访问权限的组是用户的主要组还是补充组无关紧要。

​例如，如果用户 user 有一个主要组 user 以及两个补充组 wheel 和 webadmin，那么该用户就可以读取其中任何一个组可读的文件。

​查询用户主要组及其组 GID 也可以使用 `id` 命令，具体用法详见上面对 id 命令的介绍。

## 使用超级用户权限

### 超级用户

​大多数操作系统具有某种类型的超级用户，即具有系统全部权限的用户。在 RHEL 中，此为 root 用户。该用户的特权高于文件系统上的一般特权，用于管理系统。要执行诸如安装或删除软件以及管理系统文件和目录等任务，必须将特权升级到root用户。

​普通用户能控制大部分的设备，但也有一些例外，只有此时才需要 root 用户。例如，普通用户可以控制可移动设备，如 USB 设备。因此，虽然普通用户可以添加和删除文件并可管理可移动的设备，但默认情况下，只有 root 用户才能管理“固定的”硬盘。

​root 用户这种无限制的特权也带来了职责问题。root 用户拥有足以破坏系统的无限制权限：删除文件和目录、删除用户帐户，以及添加后门等。如果 root 帐户泄露，则其他人就有可能拥有系统的管理控制权限。在一般的系统使用场景下，建议管理员以普通用户身份登录，仅在需要时升级到 root 用户特权。

​Linux 上的 root 帐户大致相当于 Microsoft Windows 上的本地 Administrator 帐户。在 Linux 中，多数系统管理员都作为无特权的用户登录，然后使用各种工具临时获得 root 特权。

### 2. 使用 `su` 命令进行用户切换

```bash
su [OPTIONS] [-] [USER [ARG...]]	# 使用替换的用户和组运行命令
# 常见选项：
-c, --command=COMMAND # 切换用户过去执行命令（慎用别名），执行完毕后切回原来的用户
-g, --group=GROUP # 指定主要组，仅适用于 root
-, -l, --login # 切换用户时，使环境变量(HOME，SHELL，USER，LOGNAME，PATH等）和欲切换的用户相同、不使用则取得用户的临时权限，不加载环境变量
```

```bash
[root@localhost ~]\# su --login student -c "ls -l"
total 0
[root@localhost ~]\# su - student
[student@localhost ~]\$ 
```

​使用 `exit` 或 `logout` 命令可以从临时切换过去的用户切换回原来的用户。

### 3. 使用 `sudo` 命令利用超级用户特权执行命令

​有时为了安全起见，root 用户的账户可能没有设置有效的密码。在这种情况下无法正常通过密码验证以 root 用户登陆，也不能通过使用 `su` 获取交互式 shell，而为了使用 root 特权，则可以使用 `sudo` 命令来临时获得 root 特权执行命令，这个过程也需要进行密码验证，不过是需要输入当前用户自己的密码。

​普通用户能执行 root 特权命令的前提是该普通为系统管理员用户，即其已经在 /etc/sudoers 中，并且已经被配置了些许可以以 root 权限运行的命令。普通用户如果没被允许执行特权命令，其使用 sudo 执行命令会被拒绝，且会被记录下来向 root 用户报告。

​使用 `visudo` 命令可以编辑 /etc/sudoers 配置文件，进行 root 权限下放的配置，RHEL7 之后 wheel 组成员默认被授予了超级用户的一些权限，它们可以使用 sudo 执行一些 root 特权命令。

> 🟢 建议在 /etc/sudoers.d 目录下补充自己的 sudo 权限访问权限而不是修改 /etc/sudoers。

​为用户配置权限的一般形式为：*用户名或%组名 ALL=(ALL)  [NOPASSWD:]ALL*，其中 NOPASSWD: 会允许当前用户或组不用输入用户自己的密码直接运行特权命令，比较危险。

​管理员用户使用 root 特权执行命令的内容会被记录到 */var/log/secure* 日志中去：

```bash
[student@localhost ~]\$ sudo tail -n 0 -f /var/log/secure
Apr 17 12:27:16 localhost sudo[9240]: student : TTY=pts/2 ; PWD=/home/student ; USER=root ; COMMAND=/bin/tail -n 0 -f /var/log/secure
Apr 17 12:27:16 localhost sudo[9240]: pam_systemd(sudo:session): Cannot create session: Already running in a session or user slice
Apr 17 12:27:16 localhost sudo[9240]: pam_unix(sudo:session): session opened for user root by root(uid=0)
```

​特殊地，管理员用户可以通过以下两种方式切换到 root，这两种方式的行为不完全相同：

```bash
[student@localhost ~]\$ sudo su -	# 推荐
[sudo] password for student: 
[root@localhost ~]\# 
[student@localhost ~]\$ sudo -i	# 虽切换到了 root 但使用的环境与上方方法有差异
[sudo] password for student: 
[root@localhost ~]\# 
```
